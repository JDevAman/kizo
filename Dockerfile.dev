FROM node:22-slim

# Install system dependencies for Prisma/Postgres
RUN apt-get update -y && apt-get install -y openssl wget \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install global CLI tools
RUN npm install -g turbo

# ğŸ“¦ 1. Copy root config and ALL package.jsons using wildcards
COPY package*.json turbo.json ./
COPY packages/*/package.json ./packages/
COPY apps/*/package.json ./apps/

# ğŸ—ï¸ 2. First install (installs structure and links)
RUN npm install

# ğŸ“‚ 3. Copy the rest of the code
COPY . .

# ğŸ”„ 4. Generate Prisma (Points specifically to your DB package)
RUN npx prisma generate --schema=./packages/kizo-db/prisma/schema.prisma

# Final command for dev
CMD ["turbo", "run", "dev"]